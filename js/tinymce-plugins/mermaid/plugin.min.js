tinymce.PluginManager.add('mermaid', function(editor, url) {
    editor.ui.registry.addButton('mermaid', {
        text: 'Mermaid Diagram',
        onAction: function() {
            editor.windowManager.open({
                title: 'Insert Mermaid Diagram',
                body: {
                    type: 'textarea',
                    name: 'code',
                    label: 'Mermaid Code'
                },
                buttons: [
                    {
                        type: 'cancel',
                        text: 'Cancel'
                    },
                    {
                        type: 'submit',
                        text: 'Insert',
                        primary: true
                    }
                ],
                onSubmit: function(api) {
                    const code = api.getData().code;
                    editor.insertContent('<div class="mermaid">' + code + '</div>');
                    api.close();
                }
            });
        }
    });
});